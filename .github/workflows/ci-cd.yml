name: CI/CD Pipeline for Google Shopping App

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-south-1
      ECR_REPOSITORY: google-shopping-repo
      CLUSTER_NAME: my-k8s-cluster
      DEPLOYMENT_FILE: k8s/deployment.yml
      SERVICE_FILE: k8s/service.yml
      EC2_USER: ec2-user
      EC2_HOST: <YOUR_EC2_PUBLIC_IP>   # replace with your EC2 public IP
      ACCOUNT_ID: <YOUR_AWS_ACCOUNT_ID> # replace with your AWS account ID

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io awscli git

      - name: Write SSH Key
        run: |
          cat > ec2-key.pem << 'EOF'
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAtJYQFbVo2i4Ffy/583GIwb2gMwn7bWkVUnOLa30wcUoXt3uj
xlae/d80ivFuXc1ZQEipLf0l6iJm9isQE6BX5sfHOOSr0J3YaK0JeRmo/2v5qDJ9
JA+/KlH/pOXfwk7wt2/XJurIJcFpZb02S836dJNoDDkapIqOycxrvaoxkTSjhDX
dVFCTtiBf/ANz93b8pegrIuyO9IJGzNr18XifCuzcu/zR4P6mBDokuUS8zHcBXao
2um9NE6UTBTIw46p9tjIWsfRRreecBwBcgdusRoNfyRv69Qbcya5iDF5CvHsOokC
JDBfv3CB3s6GGh3n4M2vZIN0sqlr4odSZ1hhsQIDAQABAoIBADr00wODWlwAsmK3
...
-----END RSA PRIVATE KEY-----
EOF
          chmod 700 ec2-key.pem
          echo "✅ SSH key created"

      - name: Test SSH Connection
        run: |
          ssh -i ec2-key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "echo Connected successfully"

      - name: Build Docker Image & Push to ECR, Deploy to Kubernetes
        run: |
          ssh -i ec2-key.pem -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            set -e

            echo "✅ Connected to EC2"

            # Install Docker & AWS CLI if missing
            sudo yum install -y docker awscli git || true
            sudo service docker start

            # Login to ECR
            aws ecr get-login-password --region $AWS_REGION | sudo docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

            # Clone repo and build Docker image
            git clone https://github.com/<YOUR_GITHUB_USERNAME>/Google-shopping-cicd.git /tmp/build || true
            cd /tmp/build
            IMAGE_TAG=$(date +%Y%m%d%H%M%S)
            IMAGE_URI=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG
            sudo docker build -t $IMAGE_URI .
            sudo docker push $IMAGE_URI

            # Update Kubernetes deployment with new image
            sed -i "s|image: .*|image: $IMAGE_URI|g" $DEPLOYMENT_FILE

            # Apply Kubernetes manifests
            kubectl apply -f $DEPLOYMENT_FILE
            kubectl apply -f $SERVICE_FILE

            echo "✅ Deployment completed successfully"
          EOF
